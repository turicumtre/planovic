<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Calendar</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #tables, #year-selection {
            display: flex;
            justify-content: center; /* Distribute space between items */
        }

        #year-selection{
          font-size:40px
        }
        table {
            border-collapse: collapse;
            margin: 10px;
            table-layout:fixed;
            width: 30%;
            max-width: 400px;
        }
        th {
            background-color:black;
            color:white
        }

        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
            width: 40px; /* Set the fixed width */
            height: 20px; /* Set the fixed height */
            overflow: hidden; /* Hide any content that overflows */
            white-space: nowrap;
            box-sizing: border-box;
        }

        td.withEntry {
            font-size: 8px;
            background-color: #cc99ff !important
        }

        td.unevenMonth {
            background-color: lightgray
        }

        td.selected {
            border: 2px solid black !important;
            background-color: darkgray;
        }

        a {
          cursor: pointer
        }

        #editor {
            width: 500px;
            padding: 10px; /* Optional: Add some padding */
            border: 1px solid #ccc; /* Optional: Add border for visibility */
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <!-- Select Year   -->
    <div id="year-selection"><a onclick="changeYear(-1)">←</a>&nbsp;<span id="year"></span>&nbsp;<a onclick="changeYear(1)">→</a></div>

    <!-- Calender -->
    <textarea id="editor"></textarea>
    <div id="tables"></div>
</body>
<script>
    const BASE_URL = "http://localhost:8080";
    const MONTH_PER_COLUMN = 4;
    let currentYear;
    let days=[];
    let selectedDayIDx=0;

    let setYearAndLoadCalendar = function(year){
      currentYear = year;
      document.getElementById("year").innerHTML=year;
      document.loadCalendar(year);
    }

    document.changeYear = function(amount){
      setYearAndLoadCalendar(currentYear+amount);
    }

    /* Helper for GET requests */
    function get(url, cb){
      url = `${BASE_URL}/api/${url}`;
      fetch(url)
        .then(res => {
          if (!res.ok) throw Error("GET error: "+url);
          return res.json();
        })
        .then(cb)
    }

    /* Helper for POST requests */
    function post(url, body, cb){
      url = `${BASE_URL}/api/${url}`;
        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        })
        .then(response => {
          if (!res.ok) throw Error("GET error: "+url);
          return res.json(); // Parse the JSON from the res
        })
        .then(cb)
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error); // Handle errors
        });
    }

    let selectDay = function(index){
       var selectedOld = days[selectedDayIDx];
       var selectedNew = days[index];
       if(!selectedNew){
         console.error("could not select cell with index "+index);
         return;
       }

       selectedDayIDx = index;

       if(selectedOld){
         selectedOld.td.classList.remove("selected");
       }
       selectedNew.td.classList.add("selected");
       document.getElementById("editor").value = selectedNew?.text || "";
    }

    function createHtmlTableCell(dayData){
        dayData.td = document.createElement('td');

        dayData.render = function(){
          dayData.td.innerHTML = `${dayData.d}${dayData.text?" | "+dayData.text:""}`;
          dayData.td.index = dayData.doy - 1;
          if(dayData.text) {
            dayData.td.classList.add("withEntry");
          }else{
            dayData.td.classList.remove("withEntry");
          }
          if(dayData.m%2==0) {
            dayData.td.classList.add("unevenMonth");
          }
        }
        if(dayData.d){
          dayData.render();
        }
        dayData.td.onclick = function(){
          selectDay(dayData.td.index);
        }

        return dayData.td;
    }

    function createHtmlTableRow(tdArray){
      tr = document.createElement('tr');
      for (let td of tdArray){
        tr.appendChild(td)
      }
      return tr;
    }

    function createEmptyCells(amount, month){
      let emptyCells = [];
      let fakeDayData = {m:month};
      for(let i=0;i<amount;i++){
          emptyCells.push(createHtmlTableCell(fakeDayData));
      }
      return emptyCells
    }

    /*
     *   <table id="table1">
     *     <thead>
     *         <tr>
     *        *     <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
     *         </tr>
     *     </thead>
     *     <tbody id="tbody1">
     *       <!-- Filled by script -->
     *     </tbody>
     *   </table>
     */
    function createHtmlTable(trArray){
      let table = document.createElement('table');
      let thead = document.createElement('thead');
      let tr = document.createElement('tr');
      ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(day=>{
        let th = document.createElement('th')
        th.innerHTML = day;
        tr.appendChild(th)
      })
      thead.appendChild(tr);

      for(let tr of trArray){
        thead.appendChild(tr);
      }

      table.appendChild(thead);
      document.getElementById("tables").appendChild(table);
    }

    /* Load annual data and create html */
    document.loadCalendar = function(year){
      /* Delete old calendar */
      document.getElementById("tables").innerHTML = "";
      let nextColumnChange = MONTH_PER_COLUMN;

      /* Download annual calendar data */
      get('cal/year/'+year, yearData => {
          let trArray = []; // table rows
          let tdArray = []; // table cells
          days = yearData.days;
          let numEmptyCellsToInsert = yearData.days[0].dow-1;
          tdArray.push(...createEmptyCells(numEmptyCellsToInsert, 1));

          for(let i=0; i<yearData.days.length; i++){
            let day = yearData.days[i];
            let nextDay = yearData.days.length>i+1 && yearData.days[i+1];
            tdArray.push(createHtmlTableCell(day))
            let startNewWeek = day.dow==7 && tdArray.length>0;
            let startNewColumn = day.m == nextColumnChange && nextDay && nextDay.m == nextColumnChange+1;

            /* Create a row if it's Sunday or if the next month starts in a new column */
            if(startNewWeek || startNewColumn){
              let tr = createHtmlTableRow(tdArray);
              trArray.push(tr);
              tdArray = []
            }

            /* Create table if the next month starts in a new column */
            if(startNewColumn){
              trArray.push(createHtmlTableRow(tdArray));
              createHtmlTable(trArray);
              trArray = [];
              if(nextDay){
                tdArray.push(...createEmptyCells(day.dow%7, nextDay?.m||1));
                nextColumnChange += MONTH_PER_COLUMN;
              }
            }
          }

          if(tdArray.length>0){
              let tr = createHtmlTableRow(tdArray);
              trArray.push(tr);
          }
          createHtmlTable(trArray);
          selectDay(yearData.currentDayOfYear-1);
      })
    }

    document.getElementById('editor').addEventListener('blur', ()=>{
      let dayData = days[selectedDayIDx];
      dayData.text = document.getElementById("editor").value;
      dayData.render();
      console.log("Saving")
      post('cal/update', {
        y: currentYear,
        m: dayData.m,
        d: dayData.d,
        text: dayData.text,
      })
    });

    /* On pageload */
    setYearAndLoadCalendar(new Date().getFullYear());
</script>
</html>
