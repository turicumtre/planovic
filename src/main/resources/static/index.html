<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Calendar</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #tables, #year-selection {
            display: flex;
            justify-content: center; /* Distribute space between items */
        }

        #year-selection{
          font-size:40px
        }
        table {
            border-collapse: collapse;
            margin: 10px;
            table-layout:fixed;
            width: 30%;
            max-width: 400px;
        }
        th {
            background-color:black;
            color:white
        }

        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
            width: 40px; /* Set the fixed width */
            height: 20px; /* Set the fixed height */
            overflow: hidden; /* Hide any content that overflows */
            white-space: nowrap;
        }

        td.withEntry {
            font-size: 10px;
            background-color: #cc99ff
        }

        a {
          cursor: pointer
        }
    </style>
</head>
<body>
    <!-- Select Year   -->
    <div id="year-selection"><a onclick="changeYear(-1)">←</a>&nbsp;<span id="year"></span>&nbsp;<a onclick="changeYear(1)">→</a></div>

    <!-- Calender -->
    <div id="tables"></div>
</body>
<script>
    const BASE_URL = "http://cal.wiibeeri.ch";
    const MONTH_PER_COLUMN = 4;
    let currentYear;

    let setYearAndLoadCalendar = function(year){
      currentYear = year;
      document.getElementById("year").innerHTML=year;
      document.loadCalendar(year);
    }

    document.changeYear = function(amount){
      setYearAndLoadCalendar(currentYear+amount);
    }

    /* Helper for GET requests */
    function get(url, cb){
      url = `${BASE_URL}/api/${url}`;
      fetch(url)
        .then(res => {
          if (!res.ok) throw Error("Error: "+url);
          return res.json();
        })
        .then(cb)
    }

    function createHtmlTableCell(dayData){
        let td = document.createElement('td');
        if(dayData.d){
          td.innerHTML = `${dayData.d}${dayData.text?" "+dayData.text:""}`;
          if(dayData.text) {
            td.className = "withEntry";
          }
        }
        if(dayData.m%2==0) {
          td.style.backgroundColor = "lightgray";
        }
        return td;
    }

    function createHtmlTableRow(tdArray){
      tr = document.createElement('tr');
      for (let td of tdArray){
        tr.appendChild(td)
      }
      return tr;
    }

    function createEmptyCells(amount, month){
      let emptyCells = [];
      let fakeDayData = {m:month};
      for(let i=0;i<amount;i++){
          emptyCells.push(createHtmlTableCell(fakeDayData));
      }
      return emptyCells
    }

    /*
     *   <table id="table1">
     *     <thead>
     *         <tr>
     *        *     <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
     *         </tr>
     *     </thead>
     *     <tbody id="tbody1">
     *       <!-- Filled by script -->
     *     </tbody>
     *   </table>
     */
    function createHtmlTable(trArray){
      let table = document.createElement('table');
      let thead = document.createElement('thead');
      let tr = document.createElement('tr');
      ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(day=>{
        let th = document.createElement('th')
        th.innerHTML = day;
        tr.appendChild(th)
      })
      thead.appendChild(tr);

      for(let tr of trArray){
        thead.appendChild(tr);
      }

      table.appendChild(thead);
      document.getElementById("tables").appendChild(table);
    }

    /* Load annual data and create html */
    document.loadCalendar = function(year){
      /* Delete old calendar */
      document.getElementById("tables").innerHTML = "";
      let nextColumnChange = MONTH_PER_COLUMN;

      /* Download annual calendar data */
      get('cal/year/'+year, yearData => {
          let trArray = []; // table rows
          let tdArray = []; // table cells
          let numEmptyCellsToInsert = yearData.days[0].dow-1;
          tdArray.push(...createEmptyCells(numEmptyCellsToInsert, 1));

          for(let i=0; i<yearData.days.length; i++){
            let day = yearData.days[i];
            let nextDay = yearData.days.length>i+1 && yearData.days[i+1];
            tdArray.push(createHtmlTableCell(day))
            let startNewWeek = day.dow==7 && tdArray.length>0;
            let startNewColumn = day.m == nextColumnChange && nextDay && nextDay.m == nextColumnChange+1;

            /* Create a row if it's Sunday or if the next month starts in a new column */
            if(startNewWeek || startNewColumn){
              let tr = createHtmlTableRow(tdArray);
              trArray.push(tr);
              tdArray = []
            }

            /* Create table if the next month starts in a new column */
            if(startNewColumn){
              trArray.push(createHtmlTableRow(tdArray));
              createHtmlTable(trArray);
              trArray = [];
              if(nextDay){
                tdArray.push(...createEmptyCells(day.dow%7, nextDay?.m||1));
                nextColumnChange += MONTH_PER_COLUMN;
              }
            }
          }

          if(tdArray.length>0){
              let tr = createHtmlTableRow(tdArray);
              trArray.push(tr);
          }
          createHtmlTable(trArray)
      })
    }

    /* On pageload */
    setYearAndLoadCalendar(new Date().getFullYear());
</script>
</html>
